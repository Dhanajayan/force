{"remainingRequest":"/Users/eve/development/force/node_modules/babel-loader/lib/index.js??ref--2-1!/Users/eve/development/force/src/desktop/apps/article/components/InfiniteScrollNewsArticle.tsx","dependencies":[{"path":"/Users/eve/development/force/src/desktop/apps/article/components/InfiniteScrollNewsArticle.tsx","mtime":1533652817000},{"path":"/Users/eve/development/force/.babelrc","mtime":1528124541000},{"path":"/Users/eve/development/force/node_modules/cache-loader/dist/cjs.js","mtime":1510929699000},{"path":"/Users/eve/development/force/node_modules/babel-loader/lib/index.js","mtime":1509489566000}],"contextDependencies":[],"result":["\"use strict\";\n\nvar _interopRequireWildcard = require(\"@babel/runtime/helpers/interopRequireWildcard\");\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.InfiniteScrollNewsArticle = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _getPrototypeOf = _interopRequireDefault(require(\"@babel/runtime/core-js/object/get-prototype-of\"));\n\nvar _classCallCheck2 = _interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));\n\nvar _createClass2 = _interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));\n\nvar _possibleConstructorReturn2 = _interopRequireDefault(require(\"@babel/runtime/helpers/possibleConstructorReturn\"));\n\nvar _inherits2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inherits\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _extend2 = _interopRequireDefault(require(\"lodash/extend\"));\n\nvar _debounce2 = _interopRequireDefault(require(\"lodash/debounce\"));\n\nvar _flatten2 = _interopRequireDefault(require(\"lodash/flatten\"));\n\nvar _moment = _interopRequireDefault(require(\"moment\"));\n\nvar _styledComponents = _interopRequireDefault(require(\"styled-components\"));\n\nvar _react = _interopRequireWildcard(require(\"react\"));\n\nvar _reactWaypoint = _interopRequireDefault(require(\"react-waypoint\"));\n\nvar _positronql2 = require(\"../../../lib/positronql\");\n\nvar _articles = require(\"../queries/articles\");\n\nvar _NewsNav = require(\"@artsy/reaction/dist/Components/Publishing/Nav/NewsNav\");\n\nvar _FollowButton = require(\"./FollowButton.js\");\n\nvar _InfiniteScrollArticle = require(\"./InfiniteScrollArticle\");\n\nvar _NewsArticle = require(\"./NewsArticle\");\n\nvar _NewsDateDivider = require(\"@artsy/reaction/dist/Components/Publishing/News/NewsDateDivider\");\n\n// FIXME: Rewire\nvar positronql = _positronql2.positronql;\n\nvar InfiniteScrollNewsArticle =\n/*#__PURE__*/\nfunction (_Component) {\n  (0, _inherits2.default)(InfiniteScrollNewsArticle, _Component);\n\n  function InfiniteScrollNewsArticle(props) {\n    var _this;\n\n    (0, _classCallCheck2.default)(this, InfiniteScrollNewsArticle);\n    _this = (0, _possibleConstructorReturn2.default)(this, (InfiniteScrollNewsArticle.__proto__ || (0, _getPrototypeOf.default)(InfiniteScrollNewsArticle)).call(this, props));\n\n    _initialiseProps.call((0, _assertThisInitialized2.default)(_this));\n\n    var article = props.articles[0] || {};\n\n    var date = _this.getDateField(article);\n\n    var omit = props.article ? props.article.id : null;\n    var offset = props.article ? 0 : 6;\n    _this.onDateChange = (0, _debounce2.default)(_this.onDateChange, 200);\n    _this.state = {\n      activeArticle: '',\n      articles: props.articles,\n      date: date,\n      display: [],\n      error: false,\n      following: (0, _FollowButton.setupFollows)() || null,\n      isEnabled: true,\n      isLoading: false,\n      offset: offset,\n      omit: omit,\n      relatedArticles: []\n    };\n    return _this;\n  }\n\n  (0, _createClass2.default)(InfiniteScrollNewsArticle, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      (0, _FollowButton.setupFollowButtons)(this.state.following);\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var isMobile = this.props.isMobile;\n      var date = this.state.date;\n      return _react.default.createElement(NewsContainer, {\n        isMobile: isMobile,\n        id: \"article-root\"\n      }, _react.default.createElement(_NewsNav.NewsNav, {\n        date: date,\n        positionTop: 61\n      }), this.renderContent(), this.renderWaypoint());\n    }\n  }]);\n  return InfiniteScrollNewsArticle;\n}(_react.Component);\n\nexports.InfiniteScrollNewsArticle = InfiniteScrollNewsArticle;\n\nvar _initialiseProps = function _initialiseProps() {\n  var _this2 = this;\n\n  Object.defineProperty(this, \"fetchNextArticles\", {\n    configurable: true,\n    enumerable: true,\n    writable: true,\n    value: function () {\n      var _value = (0, _asyncToGenerator2.default)(\n      /*#__PURE__*/\n      _regenerator.default.mark(function _callee() {\n        var _this2$state, articles, display, following, offset, omit, relatedArticles, data, newArticles, newDisplay, newRelatedArticles;\n\n        return _regenerator.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _this2$state = _this2.state, articles = _this2$state.articles, display = _this2$state.display, following = _this2$state.following, offset = _this2$state.offset, omit = _this2$state.omit, relatedArticles = _this2$state.relatedArticles;\n\n                _this2.setState({\n                  isLoading: true\n                });\n\n                _context.prev = 2;\n                _context.next = 5;\n                return positronql({\n                  query: (0, _articles.newsArticlesQuery)({\n                    offset: offset,\n                    limit: 6,\n                    omit: omit\n                  })\n                });\n\n              case 5:\n                data = _context.sent;\n                newArticles = data.articles;\n\n                if (data.display) {\n                  newDisplay = (0, _extend2.default)({}, data.display, {\n                    renderTime: (0, _moment.default)().unix()\n                  });\n                }\n\n                newRelatedArticles = [data.relatedArticlesCanvas];\n\n                if (newArticles.length) {\n                  _this2.setState({\n                    articles: articles.concat(newArticles),\n                    display: display.concat(newDisplay),\n                    relatedArticles: relatedArticles.concat(newRelatedArticles),\n                    isLoading: false,\n                    offset: offset + 6\n                  });\n\n                  (0, _FollowButton.setupFollowButtons)(following);\n                } else {\n                  _this2.setState({\n                    isEnabled: false,\n                    isLoading: false\n                  });\n                }\n\n                _context.next = 16;\n                break;\n\n              case 12:\n                _context.prev = 12;\n                _context.t0 = _context[\"catch\"](2);\n                console.error('(apps/article/InfiniteScrollNewsArticle) Error fetching next article set: ', _context.t0);\n\n                _this2.setState({\n                  isEnabled: false,\n                  isLoading: false,\n                  error: true\n                });\n\n              case 16:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[2, 12]]);\n      }));\n\n      return function value() {\n        return _value.apply(this, arguments);\n      };\n    }()\n  });\n  Object.defineProperty(this, \"renderWaypoint\", {\n    configurable: true,\n    enumerable: true,\n    writable: true,\n    value: function value() {\n      var _this2$state2 = _this2.state,\n          isEnabled = _this2$state2.isEnabled,\n          isLoading = _this2$state2.isLoading,\n          error = _this2$state2.error;\n\n      if (isEnabled) {\n        if (!isLoading) {\n          return _react.default.createElement(_reactWaypoint.default, {\n            onEnter: _this2.fetchNextArticles,\n            bottomOffset: \"-50%\"\n          });\n        } else if (!error) {\n          return _react.default.createElement(_InfiniteScrollArticle.LoadingSpinner, null, _react.default.createElement(\"div\", {\n            className: \"loading-spinner\"\n          }));\n        }\n      }\n    }\n  });\n  Object.defineProperty(this, \"onDateChange\", {\n    configurable: true,\n    enumerable: true,\n    writable: true,\n    value: function value(date) {\n      var hasNewDate = !(0, _moment.default)(date).isSame(_this2.state.date, 'day');\n\n      if (hasNewDate) {\n        _this2.setState({\n          date: date\n        });\n      }\n    }\n  });\n  Object.defineProperty(this, \"onActiveArticleChange\", {\n    configurable: true,\n    enumerable: true,\n    writable: true,\n    value: function value(id) {\n      _this2.setState({\n        activeArticle: id\n      });\n    }\n  });\n  Object.defineProperty(this, \"hasNewDate\", {\n    configurable: true,\n    enumerable: true,\n    writable: true,\n    value: function value(article, i) {\n      var articles = _this2.state.articles;\n      var beforeArticle = articles[i - 1] || {};\n\n      var beforeDate = _this2.getDateField(beforeArticle).substring(0, 10);\n\n      var currentDate = _this2.getDateField(article).substring(0, 10);\n\n      return beforeDate !== currentDate;\n    }\n  });\n  Object.defineProperty(this, \"getDateField\", {\n    configurable: true,\n    enumerable: true,\n    writable: true,\n    value: function value(article) {\n      var published_at = article.published_at,\n          scheduled_publish_at = article.scheduled_publish_at;\n      return published_at || scheduled_publish_at || (0, _moment.default)().toISOString();\n    }\n  });\n  Object.defineProperty(this, \"renderContent\", {\n    configurable: true,\n    enumerable: true,\n    writable: true,\n    value: function value() {\n      var _this2$state3 = _this2.state,\n          activeArticle = _this2$state3.activeArticle,\n          articles = _this2$state3.articles,\n          display = _this2$state3.display,\n          relatedArticles = _this2$state3.relatedArticles;\n      var _this2$props = _this2.props,\n          isMobile = _this2$props.isMobile,\n          renderTime = _this2$props.renderTime;\n      var counter = 0;\n      return (0, _flatten2.default)(articles.map(function (article, i) {\n        var hasMetaContent = i % 6 === 0 && i !== 0;\n        var displayAd = display[counter];\n        var related = relatedArticles[counter];\n\n        if (hasMetaContent) {\n          counter++;\n        }\n\n        var isTruncated = !_this2.props.article || i !== 0;\n\n        var hasDateDivider = i !== 0 && _this2.hasNewDate(article, i);\n\n        var relatedArticlesCanvas = hasMetaContent && related;\n        var displayCanvas = hasMetaContent && displayAd;\n        var hasRenderTime = hasMetaContent && (displayAd && displayAd.renderTime || renderTime);\n        return _react.default.createElement(_react.Fragment, {\n          key: \"article-\".concat(i)\n        }, hasDateDivider && _react.default.createElement(_NewsDateDivider.NewsDateDivider, {\n          date: article.published_at\n        }), _react.default.createElement(_NewsArticle.NewsArticle, {\n          isMobile: isMobile,\n          article: article,\n          isTruncated: isTruncated,\n          onDateChange: function onDateChange(date) {\n            return _this2.onDateChange(date);\n          },\n          nextArticle: articles[i + 1],\n          onActiveArticleChange: function onActiveArticleChange(id) {\n            return _this2.onActiveArticleChange(id);\n          },\n          isActive: activeArticle === article.id,\n          relatedArticlesForCanvas: relatedArticlesCanvas,\n          display: displayCanvas,\n          renderTime: hasRenderTime\n        }));\n      }));\n    }\n  });\n};\n\nvar NewsContainer =\n/*#__PURE__*/\n_styledComponents.default.div.attrs({}).withConfig({\n  displayName: \"InfiniteScrollNewsArticle__NewsContainer\",\n  componentId: \"s18wrl58-0\"\n})([\"margin-top:\", \"px;\"], function (props) {\n  return props.isMobile ? '100' : '200';\n});",{"version":3,"sources":["src/desktop/apps/article/components/InfiniteScrollNewsArticle.tsx"],"names":["positronql","InfiniteScrollNewsArticle","props","article","articles","date","getDateField","omit","id","offset","onDateChange","state","activeArticle","display","error","following","isEnabled","isLoading","relatedArticles","isMobile","renderContent","renderWaypoint","setState","query","limit","data","newArticles","newDisplay","renderTime","unix","newRelatedArticles","relatedArticlesCanvas","length","concat","console","fetchNextArticles","hasNewDate","isSame","i","beforeArticle","beforeDate","substring","currentDate","published_at","scheduled_publish_at","toISOString","counter","map","hasMetaContent","displayAd","related","isTruncated","hasDateDivider","displayCanvas","hasRenderTime","onActiveArticleChange","NewsContainer","div","attrs"],"mappings":"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","file":"/Users/eve/development/force/src/desktop/apps/article/components/InfiniteScrollNewsArticle.tsx","sourceRoot":"/Users/eve/development/force","sourcesContent":["import moment from 'moment'\nimport styled from 'styled-components'\nimport React, { Component, Fragment } from 'react'\nimport { flatten, debounce, extend } from 'lodash'\nimport Waypoint from 'react-waypoint'\nimport { positronql as _positronql } from 'desktop/lib/positronql'\nimport { newsArticlesQuery } from 'desktop/apps/article/queries/articles'\nimport {\n  ArticleData,\n  RelatedArticleCanvasData,\n  DisplayData,\n} from '@artsy/reaction/dist/Components/Publishing/Typings'\nimport { NewsNav } from '@artsy/reaction/dist/Components/Publishing/Nav/NewsNav'\nimport { setupFollows, setupFollowButtons } from './FollowButton.js'\nimport { LoadingSpinner } from './InfiniteScrollArticle'\nimport { NewsArticle } from './NewsArticle'\nimport { NewsDateDivider } from '@artsy/reaction/dist/Components/Publishing/News/NewsDateDivider'\n\nexport interface Props {\n  article?: ArticleData\n  articles: ArticleData[]\n  isMobile: boolean\n  renderTime?: number\n}\n\ninterface State {\n  activeArticle: string\n  articles: ArticleData[]\n  date: string\n  display: DisplayData[]\n  error: boolean\n  following: object[]\n  isEnabled: boolean\n  isLoading: boolean\n  offset: number\n  omit: string\n  relatedArticles: RelatedArticleCanvasData[]\n}\n\n// FIXME: Rewire\nlet positronql = _positronql\n\nexport class InfiniteScrollNewsArticle extends Component<Props, State> {\n  constructor(props) {\n    super(props)\n\n    const article = props.articles[0] || {}\n    const date = this.getDateField(article)\n    const omit = props.article ? props.article.id : null\n    const offset = props.article ? 0 : 6\n\n    this.onDateChange = debounce(this.onDateChange, 200)\n\n    this.state = {\n      activeArticle: '',\n      articles: props.articles,\n      date,\n      display: [],\n      error: false,\n      following: setupFollows() || null,\n      isEnabled: true,\n      isLoading: false,\n      offset,\n      omit,\n      relatedArticles: [],\n    }\n  }\n\n  componentDidMount() {\n    setupFollowButtons(this.state.following)\n  }\n\n  fetchNextArticles = async () => {\n    const {\n      articles,\n      display,\n      following,\n      offset,\n      omit,\n      relatedArticles,\n    } = this.state\n\n    this.setState({\n      isLoading: true,\n    })\n\n    try {\n      const data = await positronql({\n        query: newsArticlesQuery({\n          offset,\n          limit: 6,\n          omit,\n        }),\n      })\n\n      const newArticles = data.articles\n\n      let newDisplay\n      if (data.display) {\n        newDisplay = extend({}, data.display, {\n          renderTime: moment().unix(),\n        })\n      }\n      const newRelatedArticles = [data.relatedArticlesCanvas]\n\n      if (newArticles.length) {\n        this.setState({\n          articles: articles.concat(newArticles),\n          display: display.concat(newDisplay),\n          relatedArticles: relatedArticles.concat(newRelatedArticles),\n          isLoading: false,\n          offset: offset + 6,\n        })\n        setupFollowButtons(following)\n      } else {\n        this.setState({\n          isEnabled: false,\n          isLoading: false,\n        })\n      }\n    } catch (error) {\n      console.error(\n        '(apps/article/InfiniteScrollNewsArticle) Error fetching next article set: ',\n        error\n      )\n\n      this.setState({\n        isEnabled: false,\n        isLoading: false,\n        error: true,\n      })\n    }\n  }\n\n  renderWaypoint = () => {\n    const { isEnabled, isLoading, error } = this.state\n\n    if (isEnabled) {\n      if (!isLoading) {\n        return <Waypoint onEnter={this.fetchNextArticles} bottomOffset=\"-50%\" />\n      } else if (!error) {\n        return (\n          <LoadingSpinner>\n            <div className=\"loading-spinner\" />\n          </LoadingSpinner>\n        )\n      }\n    }\n  }\n\n  onDateChange = date => {\n    const hasNewDate = !moment(date).isSame(this.state.date, 'day')\n    if (hasNewDate) {\n      this.setState({ date })\n    }\n  }\n\n  onActiveArticleChange = id => {\n    this.setState({ activeArticle: id })\n  }\n\n  hasNewDate = (article, i) => {\n    const { articles } = this.state\n    const beforeArticle = articles[i - 1] || {}\n    const beforeDate = this.getDateField(beforeArticle).substring(0, 10)\n    const currentDate = this.getDateField(article).substring(0, 10)\n\n    return beforeDate !== currentDate\n  }\n\n  getDateField = article => {\n    const { published_at, scheduled_publish_at } = article\n    return published_at || scheduled_publish_at || moment().toISOString()\n  }\n\n  renderContent = () => {\n    const { activeArticle, articles, display, relatedArticles } = this.state\n    const { isMobile, renderTime } = this.props\n\n    let counter = 0\n\n    return flatten(\n      articles.map((article, i) => {\n        const hasMetaContent = i % 6 === 0 && i !== 0\n        const displayAd = display[counter]\n        const related = relatedArticles[counter]\n        if (hasMetaContent) {\n          counter++\n        }\n        const isTruncated = !this.props.article || i !== 0\n        const hasDateDivider = i !== 0 && this.hasNewDate(article, i)\n        const relatedArticlesCanvas = hasMetaContent && related\n        const displayCanvas = hasMetaContent && displayAd\n        const hasRenderTime =\n          hasMetaContent && ((displayAd && displayAd.renderTime) || renderTime)\n\n        return (\n          <Fragment key={`article-${i}`}>\n            {hasDateDivider && <NewsDateDivider date={article.published_at} />}\n            <NewsArticle\n              isMobile={isMobile}\n              article={article}\n              isTruncated={isTruncated}\n              onDateChange={date => this.onDateChange(date)}\n              nextArticle={articles[i + 1] as any}\n              onActiveArticleChange={id => this.onActiveArticleChange(id)}\n              isActive={activeArticle === article.id}\n              relatedArticlesForCanvas={relatedArticlesCanvas as any}\n              display={displayCanvas as any}\n              renderTime={hasRenderTime as any}\n            />\n          </Fragment>\n        )\n      })\n    )\n  }\n\n  render() {\n    const { isMobile } = this.props\n    const { date } = this.state\n\n    return (\n      <NewsContainer isMobile={isMobile} id=\"article-root\">\n        <NewsNav date={date} positionTop={61} />\n        {this.renderContent()}\n        {this.renderWaypoint()}\n      </NewsContainer>\n    )\n  }\n}\n\nconst NewsContainer = styled.div.attrs<{ isMobile: boolean }>({})`\n  margin-top: ${props => (props.isMobile ? '100' : '200')}px;\n`\n"]}]}